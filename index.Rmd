---
title: "Swedish Parliamantary Election 2023"
subtitle: "How do political campaigns target voters?"
author: "Fabio Votta - @favstats"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
---

<style>
    body .main-container {
        max-width: 1920px !important;
    }
</style>


```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(
    cache = F, 
    echo = F, 
    warning = F, 
    message = F, 
    cache.lazy = FALSE
)


# pacman::p_load(tidyverse, highcharter)
library(tidyverse)
library(highcharter)
library(gt)



options(scipen = 999)

# source("helpers.R")

# pro_reps <- us_advertisers %>% 
#   filter(left_vs_right == "All Republican-supporting pages")

# source("utils.R")
library(tidyverse)

# %>% 
# 
#     walk(browsSEKL)


```


```{r}
# election_dat30 %>%
# count(party,sort = T)

# library(tibble)

color_dat <- tibble(
    colors = c("#960000", "#FF4B4B", "#00A200", "#92D050", "#FBA905", "#2F5597", "#00B0F0", "#F5E903"),
    party = c("Vänsterpartiet", "Socialdemokraterna", "Miljöpartiet", "Centerpartiet", "Liberalerna", "Kristdemokraterna", "Moderata", "Sverigedemokraterna"))


# color_dat


scale_fill_parties <- function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(color_dat$colors, color_dat$party), 
        ...
    )
}
scale_color_parties <- function(...){
    ggplot2:::manual_scale(
        'color', 
        values = setNames(color_dat$colors, color_dat$party), 
        ...
    )
}

```



```{r}
# lab_dat <- readRDS("data/lab_dat.rds")



election_dat30 <- readRDS("data/kd.rds") %>% 
    # rename(internal_id = page_id) %>% 
    filter(party != "And") %>% 
  mutate(total_spend_formatted = readr::parse_number(total_spend_formatted))

# election_dat7 <- readRDS("data/election_dat7.rds") %>% 
#     rename(internal_id = page_id) %>% 
#     filter(party != "And")
#     count(coalition)


fin <- (as.Date(election_dat30$ds[1])-lubridate::days(1))
# begin7 <- fin-lubridate::days(6)
begin30 <- fin-lubridate::days(29)

append_date_suffix <- function(dates){
  dayy <- lubridate::day(dates)
  suff <- case_when(dayy %in% c(11,12,13) ~ "th",
                    dayy %% 10 == 1 ~ 'st',
                    dayy %% 10 == 2 ~ 'nd',
                    dayy %% 10 == 3 ~'rd',
                    TRUE ~ "th")
  paste0(dayy, suff)
}

create_date <- function(x) {
    the_date <- format(x, "%b %d")
    the_date <- ifelse(str_detect(the_date, " 0"),
           str_remove(the_date, "0"),
           the_date)
    str_replace(the_date, 
                as.character(lubridate::day(x)), 
                append_date_suffix(x))
}



# last7days_string <- paste0(create_date(begin7), " - ", paste(create_date(fin), lubridate::year(fin)))
last30days_string <- paste0(create_date(begin30), " - ", paste(create_date(fin), lubridate::year(fin)))

# January 26 to Febrary 24
source("utils.R")


# election_dat30 %>%# count(party)
#     filter(party == "PvdD") %>% 
#     distinct(internal_id, .keep_all = T) %>% 
#     mutate(yo = sum(total_spend_formatted))
#     filter(str_detect(value, "Butch"))
#     arrange(desc(total_spend_pct))


# election_dat30 %>% 
#     filter(party == "PvdA") %>% 
#     count(page_name, sort = T)

# fbl <- read_csv("data/FacebookAdLibraryReport_2023-02-28_NL_last_30_days_Noord-Holland.csv") %>% 
#     janitor::clean_names()
# 
# 
# yo <- all_dat %>% 
#     distinct(page_id, party)

# fbl %>% 
#     mutate(page_id = as.character(page_id)) %>% 
#     left_join(yo) %>% 
#     select(page_name, party, everything()) %>% 
#     drop_na(party) %>% 
#     openxlsx::write.xlsx("topspenders28thFeb.xlsx")
```

```{r, eval = F}
election_dat30 %>% 
  filter(is_exclusion) %>% 
  # filter(party == "PvdA") %>% 
  arrange(desc(total_spend_pct))
  count(party, sort =T)
  
# election_dat30 %>% 
#   distinct(page_id)
```


## Methodology

We monitored over 1300 Swedish political advertisers during the 2022 Swedish Parliamentary Election to better understand how campaigns use different targeting methods made available by Meta. To do this, we used data from the [Meta Ad Library](https://www.facebook.com/ads/library/), using the new 'Audience' data which gives some detail on how pages target their ads.

> Note: Meta only provides 7, 30 and 90 days windows for the targeting data in their Ad Library. 

## Topline Statistics  {.tabset .tabset-fade .tabset-pills}

### Meta {.tabset .tabset-fade .tabset-pills}




```{r}
sum30 <- election_dat30 %>% 
    distinct(internal_id, .keep_all = T) %>% 
    summarize(total_spend_formatted = sum(total_spend_formatted),
              total_num_ads = sum(total_num_ads))

# sum7 <- election_dat7 %>% 
#     distinct(internal_id, .keep_all = T) %>% 
#     summarize(total_spend_formatted = sum(total_spend_formatted),
#               total_num_ads = sum(total_num_ads))

add_ribbons <- function(x, adv, col) {
   x %>% 
  # tab_options(table.width = pct(100)) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = col,
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Number of Advertisers`,
      rows = adv
    ))
}

add_ribbons2 <- function(x, adv, col) {
   x %>% 
  # tab_options(table.width = pct(100)) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      color = col,
      weight = px(18.5),
      style = "solid"
    ),
    locations = cells_body(
      columns = `Number of Ads`,
      rows = adv
    ))
}
```


#### `r last30days_string` (Last 30 days)


In total, political parties spend kr`r scales::comma_format()(sum30$total_spend_formatted)` and ran `r sum30$total_num_ads` ad copies on Meta in this timeframe.


```{r}

get_table_dat <- function(x, var) {
    

x %>% 
        distinct(internal_id, .keep_all = T) %>% 
    group_by({{ var }}) %>% 
    summarize(total_num_ads = n()) %>% 
    drop_na() %>% 
    mutate(total_num_ads = scales::comma(total_num_ads)) %>%
    pivot_wider(names_from = {{ var }}, values_from = total_num_ads) %>% 
    mutate(`Coalizione/Partito` = "Number of Advertisers") %>% 
    bind_rows(x %>% 
        distinct(internal_id, .keep_all = T) %>% 
        group_by({{ var }}) %>% 
        arrange(desc(total_spend_formatted)) %>% 
        slice(1:3) %>% 
        mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>%
        mutate(n_words = str_count(page_name, " ")) %>% 
        # mutate(lab = paste0(word(str_remove(page_name, "-"), 1,ifelse(n_words>=2, 3, 2), sep=" "), "<br>(kr", total_spend_formatted, ")")) %>% 
        mutate(lab = paste0(page_name, " (kr", total_spend_formatted, ")")) %>%
        select({{ var }}, lab) %>% 
        drop_na() %>% 
        summarize(lab = paste0("<br>", 1:n(), ". ", lab, collapse = "")) %>% 
        pivot_wider(names_from = {{ var }}, values_from = lab) %>% 
        mutate(`Coalizione/Partito` = "Top Spenders"))  %>% 
    bind_rows(
        x %>% 
            distinct(internal_id, .keep_all = T) %>% 
            group_by({{ var }}) %>% 
            summarize(total_num_ads = sum(total_num_ads)) %>% 
            drop_na() %>% 
            mutate(total_num_ads = scales::comma(total_num_ads)) %>% 
            pivot_wider(names_from = {{ var }}, values_from = total_num_ads) %>% 
            mutate(`Coalizione/Partito` = "Number of Ads")) %>% 
    bind_rows(
        x %>% 
            distinct(internal_id, .keep_all = T) %>% 
            group_by({{ var }}) %>% 
            summarize(total_spend_formatted = sum(total_spend_formatted)) %>% 
            mutate(total_spend_formatted = scales::comma(total_spend_formatted)) %>% 
        mutate(total_spend_formatted = paste0("kr", total_spend_formatted)) %>% 
            drop_na() %>% 
            pivot_wider(names_from = {{ var }}, values_from = total_spend_formatted) %>% 
            mutate(`Coalizione/Partito` = "Total Spend") ) %>% 
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("Coalizione/Partito") %>% 
    set_names(.[nrow(.),] %>% as.character()) %>% 
    slice(1:(n()-1)) 
    
}

# debugonce(get_table_dat)
get_table_dat(election_dat30, party) %>% 
  arrange(desc(parse_number(`Total Spend`))) %>% 
  gt(
    rowname_col = "Coalizione/Partito"
    # groupname_col = "group"
  ) %>% 
  fmt_markdown(columns = everything())  %>% 
  cols_align(
    align = "center"
  ) %>% 
  gtExtras::gt_theme_538() %>%
add_ribbons("Vänsterpartiet", "#960000") %>%
add_ribbons("Socialdemokraterna", "#FF4B4B") %>%
add_ribbons("Miljöpartiet", "#00A200") %>%
add_ribbons("Centerpartiet", "#92D050") %>%
add_ribbons("Liberalerna", "#FBA905") %>%
add_ribbons("Kristdemokraterna", "#2F5597") %>%
add_ribbons("Moderata", "#00B0F0") %>%
add_ribbons("Sverigedemokraterna", "#F5E903")
  # tab_options(table.width = pct(100))  #%>%
  # tab_style(
  #   style = cell_borders(
  #     sides = c("left"),
  #     color = "#ef3e3e",
  #     weight = px(18.5),
  #     style = "solid"
  #   ),
  #   locations = cells_body(
  #     columns = `Numero di inserzionisti`,
  #     rows = "Coalizione di centro-sinistra"
  #   )) %>%
  # tab_style(
  #   style = cell_borders(
  #     sides = c("left"),
  #     color = "#0a6be1",
  #     weight = px(18.5),
  #     style = "solid"
  #   ),
  #   locations = cells_body(
  #     columns = `Numero di inserzionisti`,
  #     rows = "Coalizione di centro-destra"
  #   ))%>%
  # tab_style(
  #   style = cell_borders(
  #     sides = c("left"),
  #     color = "#0039aa",
  #     weight = px(18.5),
  #     style = "solid"
  #   ),
  #   locations = cells_body(
  #     columns = `Numero di inserzionisti`,
  #     rows = "Terzo Polo"
  #   ))%>%
  # tab_style(
  #   style = cell_borders(
  #     sides = c("bottom"),
  #     color = "lightgrey",
  #     weight = px(0.5),
  #     style = "solid"
  #   ),
  #   locations = cells_body(
  #     columns = everything(),
  #     rows = everything()
  #   ))
  # 



```




## Spending per Targeting Criteria {.tabset .tabset-fade .tabset-pills}

How much did campaigns spend on different targeting methods?



### `r last30days_string` (Last 30 days) {.tabset .tabset-fade .tabset-pills}


#### Overall


```{r, fig.width=8, fig.height=5, dpi=300}
coltototal30 <- election_dat30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "SEK") %>% 
        calc_targeting() 

gg <- coltototal30 %>% 
  filter(perc >= 0.01) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAPHY: Sweden",
    target == "regions" ~ "GEOGRAPHY: Regions",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interests",
    target == "age" ~ "Age",
    target == "zips" ~ "GEOGRAPHY: Postal Code",
    target == "CITY" ~ "GEOGRAPHY: City",
    target == "language" ~ "Language",
    target == "gender" ~ "Gender",
    target == "COMUNE" ~ "GEOGRAPHY: Municipality",
    target == "electoral_districts" ~ "GEOGRAPHY: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAPHY: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAPHY: Neighborhood",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  #%>% 
    # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
    #                               "Terzo Polo",
    #                               "Coalizione di centro-destra")))

library(tidytext)

the_order <- gg %>% 
    complete(target, fill = list(perc= 0)) %>% 
    # filter(coalition == "Coalizione di centro-sinistra")  %>% 
    mutate(target = fct_reorder(target, perc, .desc = F)) %>% 
    pull(target) %>% levels

gg %>% 
    mutate(target = fct_relevel(target, the_order)) %>%
    # mutate(target = reorder_within(target, perc)) %>%
    ggplot(aes(target, perc)) +
    geom_col(fill = "darkgrey", alpha = 0.7) +
    # scale_x_reordered() +
    coord_flip() +
    # facet_wrap(~party, scales = "free", ncol = 3) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))   +
  geom_text(size = 2.5,
             aes(y = perc + 3, label = paste0(round(perc, 1), "%")),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") 


```


#### By Party


```{r, fig.width=14, fig.height=12, dpi=300}


col_each30 <- election_dat30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(main_currency == "SEK") %>% 
    group_split(party) %>% 
    map_dfr(~{
        calc_targeting(.x) %>% 
            mutate(#coalition = .x$coalition[1],
                   party = .x$party[1])
    })


# calc_targeting()

# 
# spend_on_each_lombardy30 %>% 
#     ggplot(aes(target, perc)) +
#     geom_col(aes(fill = coalition)) +
#     coord_flip() +
#     facet_wrap(~coalition) +
#     theme(legend.position = "none")

plot_geography <- function(x) {
    
gg <- x %>% 
  filter(perc >= 0.01) %>%
  add_count(target) %>% 
  # filter(n == 3) %>% 
  mutate(target = case_when(
    target == "custom_audience" ~ "Custom Audiences",
    target == "countries" ~ "GEOGRAPHY: Sweden",
    target == "regions" ~ "GEOGRAPHY: Regions",
    target == "lookalike_audience" ~ "Lookalike Audiences",
    target == "interest" ~ "Interests",
    target == "age" ~ "Age",
    target == "zips" ~ "GEOGRAPHY: Postal Code",
    target == "CITY" ~ "GEOGRAPHY: City",
    target == "language" ~ "Language",
    target == "gender" ~ "Gender",
    target == "COMUNE" ~ "GEOGRAPHY: Municipality",
    target == "electoral_districts" ~ "GEOGRAPHY: Electoral Districts",
    target == "COUNTY" ~ "GEOGRAPHY: Counties",
    str_detect(target, "NEIGHBOR") ~ "GEOGRAPHY: Neighborhood",
    T ~ target
  )) %>% 
    filter(target != "Unknown") %>% 
    arrange(desc(perc))  #%>% 
    # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
    #                               "Terzo Polo",
    #                               "Coalizione di centro-destra")))

the_order <- gg %>% 
    complete(party, target, fill = list(perc= 0)) %>% 
    # filter(coalition == "Coalizione di centro-sinistra")  %>% 
    mutate(target = fct_reorder(target, perc, .desc = F)) %>% 
    pull(target) %>% levels

gg %>% 
    # mutate(target = fct_relevel(target, the_order)) %>%
    mutate(target = reorder_within(target, perc, party)) %>% 
    ggplot(aes(target, perc)) +
    geom_col(aes(fill = party)) +
    scale_x_reordered() +
    coord_flip() +
    facet_wrap(~party, scales = "free", ncol = 3) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1"))   +
  geom_text(size = 2.5,
             aes(y = perc + 9, label = paste0(round(perc, 1), "%"), group = party),
             position = position_dodge(width = 0.9)) +
  theme(legend.position = "none", text=element_text(family="mono", face = "bold")) +
  labs(x = "", y = "\nBudget spent on targeting method (% of Total spend)", caption = "Source: Meta Ad Library. Data Viz: Fabio Votta (@favstats).") +
    ylim(0, 80)

}

library(tidytext)
plot_geography(col_each30) +
    scale_fill_parties()

# col_each30 %>%
#     mutate(target = reorder_within(target, perc, party))
```



## Top Targeted Audiences {.tabset .tabset-fade .tabset-pills}

Here, we show the *top targeted audiences* for each party (ranked by amount of SEK spend). Most (but not all) of these audiences are “interest” audiences, i.e. the parties targeted people interested in “Books” or “Politics”.

```{r}

interest_targeting30 <-  election_dat30 %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(type == "detailed") %>%
    # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
    mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>%
    mutate(total_spend = total_spend * total_spend_pct) %>%
    filter(main_currency == "SEK")  %>%
    # left_join(page_names %>% select(internal_id = page_id, page_name) %>% distinct(internal_id, .keep_all =T)) %>%
    # left_join(us_advertisers %>% rename(internal_id = page_id)) %>%
    # drop_na(left_vs_right) %>%
    mutate(value = paste0(detailed_type,": ", value)) %>% 
    group_by(party, value, is_exclusion, detailed_type) %>%
    summarise(total_spend = sum(total_spend)) %>%
    ungroup() %>%
    arrange(desc(total_spend)) 

# election_dat30 %>% 
#     filter(!is_exclusion) %>% 
#     group_by(party)
#     ggplot(aes())
    
contested_dat30 <- interest_targeting30 %>% 
  filter(!is_exclusion) %>% 
  # filter(total_spend >= 40000) %>% 
  filter(total_spend >= 1) %>%
  # add_count(value) %>% 
  # filter(n >= 5) %>% 
  group_by(party) %>% 
  mutate(total_spenderino = sum(total_spend)) %>% 
  mutate(perc = total_spend/total_spenderino) %>%
  mutate(value = str_remove_all(value, "INTERESTS: |DEMOGRAPHICS: |BEHAVIORS: ")) %>% 
  mutate(value = str_replace_all(value, " \\s*\\([^\\)]+\\)", ""))



```

```{r,fig.width=9, fig.height=5,eval=F, dpi = 300}
library(tidytext)
 interest_targeting30 %>% 
  filter(is_exclusion) %>% 
  # filter(total_spend >= 40000) %>% 
  filter(total_spend >= 1) %>%
  # add_count(value) %>% 
  # filter(n >= 5) %>% 
  group_by(party) %>% 
  mutate(total_spenderino = sum(total_spend)) %>% 
  mutate(perc = total_spend/total_spenderino)  %>%
    mutate(value = reorder_within(value, total_spend, party)) %>% 
    # filter(party == "BBB") %>%
    # slice(1:30) %>%
  # mutate(value = fct_reorder(value, total_spend)) %>% 
  ggplot(aes(value, total_spend)) +
  geom_col(aes(fill = party), width = 0.29) +
  coord_flip() +
  scale_fill_parties() +
  
    scale_x_reordered()  +
  ggthemes::theme_hc() +
  labs(x = "Exclusion criteria\n", y = "Budget spent on targeting method (in SEK)", title = "Top Excluded Audiences by Party", subtitle = "On Meta you can exclude audiences that you don't want to see your ads\n", 
       caption = "\nSource: Meta Ad Library and data compiled by Who Targets Me. Data Viz: Fabio Votta (@favstats).  Timeframe: 12th Feb - 13th Mar 2023.") +
  theme(plot.title = element_text(size = 38, face = "bold", hjust = 0.5), text=element_text(family="mono", face = "bold"), plot.caption = element_text(), plot.subtitle = element_text(hjust = 0.5, size = 20)) +
  theme(legend.position = "none") +
  facet_wrap(~party, scales = "free")
```


### `r last30days_string` (Last 30 days)

```{r, eval = F}
contested_dat30 %>% 
  mutate(party = stringi::stri_enc_tonative(party)) %>% 
  mutate(party = case_when(
    str_detect(party, "nsterpartiet") ~ "Vänsterpartiet",
    # str_detect(party, "nsterpartiet") ~ "Vänsterpartiet",
    )) %>% 
  mutate(party = case_when(
    str_detect(party, "nsterpartiet") ~ "Vänsterpartiet",
    # str_detect(party, "nsterpartiet") ~ "Vänsterpartiet",
    )) %>% 
  count(party)
    filter(party == "V<U+00E4>nsterpartiet")

contested_dat30  %>% count(party)
    filter(party == "Vänsterpartiet") %>% 
    group_by(party) %>%
    arrange(desc(perc)) %>% 
    slice(1:10) %>% 
    ungroup()
```


```{r, fig.width=14, fig.height=13, dpi=300}
contested_dat30 %>% 
    group_by(party) %>%
    arrange(desc(perc)) %>% 
    slice(1:10) %>%
    mutate(value = reorder_within(value, total_spend, party)) %>% 
    ggplot(aes(value, total_spend, fill = party)) +
    geom_col() +
    facet_wrap(~party, scales = "free", ncol = 3)+
    coord_flip()  +
    scale_x_reordered() +
    scale_fill_parties() +
  ggthemes::theme_hc() +
  labs(x = "Targeting criteria", y = "Budget spent on targeting method (in SEK)", #title = "Contested targeted interests (US midterms 2022)", subtitle = " ", 
       caption = "Source: Meta Ad Library and data compiled by Who Targets Me. Data Viz: Fabio Votta (@favstats).") +
  theme(legend.position = "bottom", plot.title = element_text(size = 28, face = "bold"), text=element_text(family="mono", face = "bold"), plot.caption = element_text()) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE)) 
```


## Top Contested Audiences {.tabset .tabset-fade .tabset-pills}

Here, we show the *top most contested audiences*, i.e. where all parties have spent considerable amounts of money competing to reach voters with the same interests. Most (but not all) of these audiences are “interest” audiences, i.e. the parties targeted people interested in “Books” or “Politics”. In each row on the right hand side, you can see how much in total was spend on that specific target audience.

### `r last30days_string` (Last 30 days)

```{r, fig.width  = 13, fig.height=15}
# election_dat30 %>% 
#     count(party, sort = T) %>% 
#     pull(party) %>% 
#     dput()







# get_contested_graph <- function(ppp, col_string, col_colors) {




get_contested_graph <- function(ppp) {
    
    
interest_targeting <-  ppp %>% 
    mutate(total_spend = total_spend_formatted) %>% 
    filter(type == "detailed") %>%
    # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
    mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>%
    mutate(total_spend = total_spend * total_spend_pct) %>%
    filter(main_currency == "SEK")  %>%
    # left_join(page_names %>% select(internal_id = page_id, page_name) %>% distinct(internal_id, .keep_all =T)) %>%
    # left_join(us_advertisers %>% rename(internal_id = page_id)) %>%
    # drop_na(left_vs_right) %>%
    mutate(value = paste0(detailed_type,": ", value)) %>% 
    group_by(party, value, is_exclusion, detailed_type) %>%
    summarise(total_spend = sum(total_spend)) %>%
    ungroup() %>%
    arrange(desc(total_spend)) 

contested_dat <- interest_targeting %>% 
  filter(!is_exclusion) %>% 
  filter(total_spend >= 40000) %>%
  # filter(total_spend >= 10000) %>%
  add_count(value) %>% 
  filter(n >= 2) %>% 
    # distinct(party, value) %>% 
  group_by(value) %>% 
  mutate(total_spenderino = sum(total_spend)) %>% 
  mutate(perc = total_spend/total_spenderino) %>%
  # mutate(value = str_remove_all(value, "INTERESTS: |DEMOGRAPHICS: |BEHAVIORS: ")) %>% 
  mutate(value = str_replace_all(value, " \\s*\\([^\\)]+\\)", ""))


the_order <- contested_dat %>% 
  filter(str_detect(party, "nsterpartiet")) %>%  
  arrange(desc(perc)) %>% 
  pull(value) %>% 
  unique()

lab_dat <- contested_dat %>% 
  # distinct(value, .keep_all = T) %>% 
  filter(str_detect(party, "nsterpartiet")) %>% 
  mutate(labb = paste0("kr", scales::comma(round(total_spenderino)))) %>% 
  select(party, value, labb)



contested_dat %>% #count(party) %>% pull(party) %>% unique() %>% dput()
  # mutate(the_order = )
  left_join(lab_dat) %>% 
  mutate(value = factor(value, the_order)) %>% 
    drop_na(value) %>% 
    # add_count(party, value, name = "db") %>% 
    # filter(db == 1) %>% 
  # mutate(party = factor(party, col_string)) %>%
  # filter()
  ggplot(aes(value, perc)) +
  geom_col(aes(fill = party), position = position_stack(), alpha = 0.8) +
  coord_flip() +
  geom_label(aes(label = labb),y=1.225,
            position = position_stack(vjust = 0.5),
            hjust = 1, label.size = NA,
            size = 4) + expand_limits(y = 1.2) +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  # scale_fill_manual("Page Groups", values = c("#ff2700", "#008fd5")) +
  ggthemes::theme_hc() +
  labs(x = "Targeting criteria", y = "% of budget spent on targeting method", #title = "Contested targeted interests (US midterms 2022)", subtitle = " ", 
       caption = "Source: Meta Ad Library and data compiled by Who Targets Me. Data Viz: Fabio Votta (@favstats).") +
  theme(legend.position = "bottom", plot.title = element_text(size = 28, face = "bold"), text=element_text(family="mono", face = "bold"), plot.caption = element_text()) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE)) 
    
}


# c("Terzo Polo", "Coalizione di centro-destra", "Coalizione di centro-sinistra", 
# "Unione Popolare")

```


```{r, fig.width  = 11, fig.height=15}
# GroenLinks	3235		
# Vänsterpartiet	972		
# PvdA	706		
# CDA	604		
# SP	388		
# PvdD	352		
# PVV	243		
# D66	214		
# FvD	177		
# Ja21	149	
main_parties <- c("Vänsterpartiet", "FvD", "GroenLinks", "PvdA", "CDA", "SP", "PVV", "D66", "PvdD", "Ja21", "CDA")
# debugonce(get_contested_graph)
election_dat30 %>% 
    # filter(party %in% main_parties) %>% 
    get_contested_graph()  +
    scale_fill_parties()


```


## Geo Targeting {.tabset .tabset-fade .tabset-pills}

### `r last30days_string` (Last 30 days) {.tabset .tabset-fade .tabset-pills}

#### Regions

```{r, eval =F}
library(tidyverse)
library(highcharter)


set.seed(110)

ex <- data.frame(
    Level1 = rep(paste0("Country", seq(1:5)), each = 5),
    Level2 = rep(paste0("Sector", seq(1:5)), 5),
    Percentage = runif(25, 0, 1)
)

ex %>%
    data_to_hierarchical(c(Level1, Level2), Percentage) %>%
    hchart(type = "treemap",
           allowTraversingTree = T,
           levelIsConstant = F,
           levels = list(
               list(level = 1, dataLabels = list(enabled = TRUE,
                                                 format = "{point.name}<br>
                                                      {point.value}%"), borderColor = "black", borderWidth = 2),
               list(level = 2, dataLabels = list(enabled = FALSE))
           )
    )
```

```{r, eval =F}
election_dat30 %>%
  distinct() %>%
  filter(type == "location") %>%
  filter(location_type == "regions") %>%
  filter(!is_exclusion)  %>%
  mutate(likely_together = paste0(total_spend_pct,num_ads) %>% as.factor() %>% as.numeric()) %>%
  group_by(page_id) %>%
  add_count(likely_together, name = "n_clusters") %>%
  ungroup()  %>% #count(party)
  filter(party == "Kristdemokraterna") %>%
  arrange(desc(n_clusters))  %>%
  mutate(total_spend_formatted = total_spend_formatted/n_clusters) %>%
  select(value, num_ads, likely_together, n_clusters, total_spend_formatted, everything()) %>%
  summarize(total_spend_formatted = sum(total_spend_formatted))
```


```{r,fig.width=10, fig.height=8}
library(treemap)
region_dat <- election_dat30 %>%
  filter(type == "location") %>%
  filter(location_type == "regions") %>%
  filter(!is_exclusion)  %>%
  mutate(likely_together = paste0(total_spend_pct,num_ads) %>% as.factor() %>% as.numeric()) %>%
  group_by(page_id) %>%
  add_count(likely_together, name = "n_clusters") %>%
  ungroup() %>%
  mutate(total_spend_formatted = total_spend_formatted*total_spend_pct) %>%
  mutate(total_spend_formatted = total_spend_formatted/n_clusters) %>%
  group_by(party, value) %>%
  summarise(total_spend_formatted = sum(total_spend_formatted),
            num_ads = sum(num_ads)) %>%
  ungroup() %>%
  rename(region = value) %>%
  mutate(region = str_remove_all(region, "County, Sweden")) 

the_colors <- region_dat %>% 
  group_by(party) %>% 
  summarize(total_spend_formatted = sum(total_spend_formatted)) %>% 
  ungroup() %>% 
  mutate(party = fct_relevel(party)) %>% 
  left_join(color_dat) %>% 
  arrange(party) %>% 
  drop_na(colors) %>% 
  pull(colors)

## Static version
tm <- treemap(region_dat, index = c("party", "region"),
              vSize = "total_spend_formatted", 
              vColor = "party",
              type = "index",
              title = "",
                  align.labels=list(
        c("left", "top"),
        c("center", "center")
        ),
                  fontsize.labels=c(21,10),                # size of labels. Give the size per level of aggregation: size for group, size for subgroup, sub-subgroups...

                  fontcolor.labels=c("white","white"),    # Color of labels
              palette = the_colors)



```


#### Cities

```{r,fig.width=10, fig.height=8}

city_dat <- election_dat30 %>%
  filter(type == "location") %>%
  filter(location_type == "CITY") %>%
  filter(!is_exclusion)  %>%
  mutate(likely_together = paste0(total_spend_pct,num_ads) %>% as.factor() %>% as.numeric()) %>%
  group_by(page_id) %>%
  add_count(likely_together, name = "n_clusters") %>%
  ungroup() %>%
  mutate(total_spend_formatted = total_spend_formatted*total_spend_pct) %>%
  mutate(total_spend_formatted = total_spend_formatted/n_clusters) %>%
  group_by(party, value) %>%
  summarise(total_spend_formatted = sum(total_spend_formatted),
            num_ads = sum(num_ads)) %>%
  ungroup() %>%
  rename(region = value) %>%
  mutate(region = str_remove_all(region, ", Sweden")) 

the_colors <- city_dat %>% 
  group_by(party) %>% 
  summarize(total_spend_formatted = sum(total_spend_formatted)) %>% 
  ungroup() %>% 
  mutate(party = fct_relevel(party)) %>% 
  left_join(color_dat) %>% 
  arrange(party) %>% 
  drop_na(colors) %>% 
  pull(colors)

## Static version
tm <- treemap(city_dat, index = c("party", "region"),
              vSize = "total_spend_formatted", 
              vColor = "party",
              type = "index",
              title = "",
                  align.labels=list(
        c("left", "top"),
        c("center", "center")
        ),
                  fontsize.labels=c(14,7.5),                # size of labels. Give the size per level of aggregation: size for group, size for subgroup, sub-subgroups...

                  fontcolor.labels=c("white","white"),    # Color of labels
              palette = the_colors)
```


```{r,fig.width=10, fig.height=8, eval = F}
hctreemap(tm, allowDrillToNode = TRUE) %>%
   hc_title(text = "Gross National Income World Data") %>%
   hc_tooltip(pointFormat = "<b>{point.name}</b>:<br>
                             Pop: {point.valuecolor:,.0f}<br>
                             GNI: {point.value:,.0f}")
  # count(location_type)

# set options
hcoptslang <- getOption("highcharter.lang")
hcoptslang$thousandsSep <- ","
options(highcharter.lang = hcoptslang)

fntltp <- JS("function(){
  return this.point.x + ' ' +  this.series.yAxis.categories[this.point.y] + ': ' +
  Highcharts.numberFormat(this.point.value, 2);
}")


region_dat %>%
    data_to_hierarchical(c(party, region), total_spend_formatted, colors = unique(color_dat$colors)) %>%
    hchart(#color = unique(color_dat$colors),
           # group_vars = "party",
           type = "treemap",
           color_var = "party",
           # hcaes(color = party),
           # colorByPoint = TRUE,
           allowTraversingTree = T,
           levelIsConstant = F,
           # fill = party,
           levels = list(
               list(level = 1, dataLabels = list(enabled = TRUE,
                                                 format = "{point.name}<br>
                                                      kr{point.value:,.0f}"), borderColor = "black", borderWidth = 2),
               list(level = 2, dataLabels = list(enabled = FALSE))
           )
    ) #%>%
  # hchart(hcaes(color = party))

    # hc_plotOptions(treemap = list(colorByPoint = TRUE)) %>%   #with this we can set the colors, note: 1st color is given to first row in the data frame (not necessarily the biggest box)
    # hc_colorAxis(dataClassColor = "category",
                 # colors = unique(color_dat$colors)) %>%
    # hc_legend(enabled = FALSE) %>%

  # hc_colors(unique(color_dat$colors))
```

<!-- ```{r} -->
<!-- hctreemap2(region_dat %>%  -->
<!--              mutate(party_num = as.numeric(as.factor(party))),  -->
<!--            group_vars = c("region", "party"), -->
<!--            size_var = "total_spend_formatted", -->
<!--            allowTraversingTree = T, -->
<!--            levelIsConstant = F, -->
<!--                color_var = "party_num", -->
<!--            # fill = party, -->
<!--            levels = list( -->
<!--                list(level = 1, dataLabels = list(enabled = TRUE,  -->
<!--                                                  format = "{point.name}<br> -->
<!--                                                       kr{point.value:,.0f}"), borderColor = "black", borderWidth = 2), -->
<!--                list(level = 2, dataLabels = list(enabled = FALSE)) -->
<!--            ) -->
<!--     ) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- df <- data.frame( -->
<!--   "group" = letters[1:24], -->
<!--   "group2" = rep(c("hello", "no", "what", "wa", "awe", "so"), 4), -->
<!--   "color" = rep(letters[1:6], each = 4), -->
<!--   "size" = rpois(24, 100) -->
<!-- ) -->
<!-- df$color_numeric <- as.numeric(as.factor(df$color)) -->
<!-- color_pal <- RColorBrewer::brewer.pal(max(length(unique(df$color_numeric)), 3), "Paired") -->

<!-- hctreemap2(df, group_vars = c("group2", "group"), -->
<!--            size_var = "size", -->
<!--                       allowTraversingTree = T, -->
<!--            levelIsConstant = F, -->
<!--            color_var = "color_numeric") %>% -->
<!--   hc_legend(enabled = FALSE) %>% -->
<!--   hc_colorAxis( -->
<!--     dataClassColor = "category", -->
<!--     dataClasses = color_classes(df$color_numeric, colors = color_pal) -->
<!--   ) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- library(dplyr) -->
<!-- data(pokemon) -->

<!-- lvl_opts <-  list( -->
<!--     list( -->
<!--       level = 1, -->
<!--       borderWidth = 0, -->
<!--       borderColor = "transparent", -->
<!--       dataLabels = list( -->
<!--         enabled = TRUE, -->
<!--         align = "left", -->
<!--         verticalAlign = "top", -->
<!--         style = list( -->
<!--           fontSize = "12px",  -->
<!--           textOutline = FALSE, -->
<!--           color = "white", -->
<!--           fontWeight = "normal" -->
<!--           ) -->
<!--       ) -->
<!--     ), -->
<!--     list( -->
<!--       level = 2, -->
<!--       borderWidth = 0, -->
<!--       borderColor = "transparent", -->
<!--       colorVariation = list(key = "brightness", to = 0.250), -->
<!--       dataLabels = list(enabled = FALSE), -->
<!--       style = list( -->
<!--         fontSize = "8px", -->
<!--         textOutline = FALSE,  -->
<!--         color = "white",  -->
<!--         fontWeight = "normal" -->
<!--         ) -->
<!--     ) -->
<!--   ) -->

<!-- pkmn_min <- pokemon |>  -->
<!--   select(type_1, type_2, type_1_color) |> -->
<!--   mutate(type_1 = stringr::str_to_title(type_1)) |>  -->
<!--   mutate(type_2 = ifelse(is.na(type_2), type_1, paste(type_1, "-", type_2))) |> -->
<!--   mutate(val = 1) -->

<!-- cols <- pkmn_min |>  -->
<!--   count(type_1, type_2, type_1_color, sort = TRUE) |>  -->
<!--   pull(type_1_color) |>  -->
<!--   unique() -->

<!-- hchart( -->
<!--   data_to_hierarchical(pkmn_min, c(type_1, type_2), val, colors = cols), -->
<!--   type = "treemap", -->
<!--   # levelIsConstant = FALSE, -->
<!--   allowDrillToNode = TRUE, -->
<!--   levels = lvl_opts, -->
<!--   tooltip = list(valueDecimals = FALSE) -->
<!--   ) |>  -->
<!--   hc_chart( -->
<!--     style = list(fontFamily = "Gloria Hallelujah") -->
<!--   ) |>  -->
<!--   hc_title( -->
<!--     text = "Gotta Catch 'Em All!", -->
<!--     style = list(fontFamily = "Gloria Hallelujah") -->
<!--     ) |>  -->
<!--   hc_size(height = 700) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- region_dat %>%  -->
<!--     data_to_hierarchical(c(party, region), total_spend_formatted)  -->
<!-- ``` -->


<!-- ```{r} -->
<!-- library(RColorBrewer) -->

<!-- df %>% -->
<!--   hctreemap2( -->
<!--     group_vars = c("index1", "index2", "index3"), -->
<!--     size_var = "value", -->
<!--     color_var = "color_value", -->
<!--     layoutAlgorithm = "squarified", -->
<!--     levelIsConstant = FALSE, -->
<!--     levels = list( -->
<!--       list(level = 1, dataLabels = list(enabled = TRUE)), -->
<!--       list(level = 2, dataLabels = list(enabled = FALSE)), -->
<!--       list(level = 3, dataLabels = list(enabled = FALSE)) -->
<!--     ) -->
<!--   )  %>% -->
<!--   hc_colorAxis( -->
<!--     dataClassColor = "category", -->
<!--     dataClasses = color_classes(df$color_numeric, colors = color_pal) -->
<!--   ) %>% -->
<!--   hc_tooltip(pointFormat = "<b>{point.name}</b>:<br> -->
<!--              Value: {point.value:,.0f}<br> -->
<!--              Color Value: {point.colorValue:,.0f}") -->

<!-- ``` -->



## Age Targeting {.tabset .tabset-fade .tabset-pills}

### `r last30days_string` (Last 30 days)

```{r, fig.width= 10, fig.height=7, dpi = 300}
get_targ_perc <- function(x, var) {
    
x <<- x
total_sppppeen <- x %>% 
# filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(total_spend = total_spend_formatted) %>%
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_budget = sum(total_spend)) %>% 
  ungroup()


x %>% 
  mutate(total_spend = total_spend_formatted) %>%
  mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>% 
  # filter(coalition == "Coalizione di centro-destra") %>%  
  filter(type == var) %>%   
  # filter(total_spend_pct != 0) %>% 
  # group_by(internal_id) %>%
  # mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  # ungroup()%>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  group_by(value) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  bind_cols(total_sppppeen) %>% 
  mutate(perc = spend_per/total_budget) %>% 
            mutate(coalition = x$coalition[1],
                   party = x$party[1],
                   election = x$election[1])
    
}


age_targeting <- election_dat30 %>% 
    group_split(party) %>% 
    map_dfr(get_targ_perc, "age")
    
# age_targeting %>% 
#      mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
#                                   "Terzo Polo",
#                                   "Coalizione di centro-destra"))) %>% 
#     filter(!(value %in% 13:17)) %>% 
#     ggplot(aes(value, perc, fill = coalition)) +
#     geom_col() +
#     facet_wrap(~coalition) +
#     ggthemes::theme_hc() +
#     scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
#     theme(legend.position = "none") +
#     scale_y_continuous(labels = scales::percent) +
#     scale_x_discrete(breaks = c("18", "24",
#                                 "34", "44",
#                                 "54", "65+")) +
#     labs(y = "% Budget Spend on Age")


# lombardy30 %>% 
#     group_split(coalition, election) %>% 
#     map_dfr(get_targ_perc, "age")
    
age_targeting %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% 13:17)) %>% 
    mutate(age_groups = case_when(
        value %in% 18:24 ~ "18-24",
        value %in% 25:34 ~ "25-34",
        value %in% 35:44 ~ "35-44",
        value %in% 45:54 ~ "45-54",
        value %in% 55:64 ~ "55-64",
        T ~ value
    )) %>% 
    group_by(age_groups, party) %>%
    summarize(spend_per = mean(spend_per),
              total_budget = unique(total_budget))  %>% 
  mutate(perc = spend_per/total_budget)  %>% 
    mutate(age_groups = factor(age_groups,
                               c("18-24",
                                 "25-34",
                                 "35-44",
                                 "45-54",
                                 "55-64", "65+") %>% rev)) %>% 
    ggplot(aes(age_groups, perc, fill = party)) +
    geom_col(width = 0.5) +
    facet_wrap(~party) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Age Group") +
    coord_flip() +
    labs(x = "Age Groups\n")  +
  geom_text(size = 3.5, color = "white",
             aes(y = perc - 0.19, label = paste0(round(perc*100, 1), "%"))) +
    scale_fill_parties()
    
```


## Gender Targeting {.tabset .tabset-fade .tabset-pills}

### `r last30days_string` (Last 30 days)

```{r, fig.width= 8, fig.height=5, dpi = 300}


gender_targeting <- election_dat30 %>% 
group_split(party) %>% 
map_dfr(get_targ_perc, "gender")

gender_targeting %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    filter(!(value %in% "All")) %>% 
    group_by(party) %>% 
    mutate(percsum = sum(perc)) %>% 
    ungroup() %>% 
    filter(percsum != 0) %>% 
    ggplot(aes(value, perc)) +
    geom_col(width = 0.5, aes(fill = party)) +
    facet_wrap(~party) +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Gender") +
    coord_flip() +
    labs(x = "Gender\n")  +
  geom_label(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%"))) +
    scale_fill_parties()
    
```

## Education Targeting {.tabset .tabset-fade .tabset-pills}

### `r last30days_string` (Last 30 days)

```{r, fig.width= 12, fig.height=10, dpi = 300}


calc_edu_perc <- function(x) {
    
total_sppppeen <- x %>% 
# filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(total_spend = total_spend_formatted) %>%
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_budget = sum(total_spend)) %>% 
  ungroup()

x %>% 
    filter(type == "detailed") %>%
    filter(detailed_type == "DEMOGRAPHICS") %>% 
  filter(!is_exclusion) %>% 
    # count(value, sort = T) %>% 
    filter(str_detect(value, "grad school|degree|	|Master|[c|C]ollege|degree|[H|h]igh school|Professional degree")) %>% 
    filter(str_detect(value, "Wine", negate = T)) %>% 
  mutate(total_spend = total_spend_formatted) %>%
  mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>% 
  # filter(coalition == "Coalizione di centro-destra") %>%  
  # filter(total_spend_pct != 0) %>% 
  # group_by(internal_id) %>%
  # mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  # ungroup()%>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  group_by(value) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  bind_cols(total_sppppeen) %>% 
  mutate(perc = spend_per/total_budget) %>% 
            mutate(coalition = x$coalition[1],
                   party = x$party[1],
                   election = x$election[1])
}

election_dat30 %>% 
    group_split(party) %>% 
    map_dfr(calc_edu_perc) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
                                  # "Terzo Polo",
                                  # "Coalizione di centro-destra"))) %>% 
    # mutate(value = fct_reorder(value, perc)) %>% 
  
    mutate(value = reorder_within(value, perc, party)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    scale_x_reordered() +
    geom_col(alpha = 0.8) +
    facet_wrap(~party, scales = "free_y") +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Education") +
    labs(x = "Education\n")   +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 2), "%"))) +
    scale_fill_parties()
    


    
```

## Job Targeting {.tabset .tabset-fade .tabset-pills}


### `r last30days_string` (Last 30 days)

```{r, fig.width= 13, fig.height=12, dpi = 300}


calc_jobs_perc <- function(x) {
    
total_sppppeen <- x %>% 
# filter(coalition == "Coalizione di centro-destra") %>% 
  mutate(total_spend = total_spend_formatted) %>%
  distinct(internal_id, .keep_all = T)  %>%
  # mutate(total_spend = readr::parse_number(total_spend_formatted)) %>%
  mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>% 
  select(internal_id, total_spend) %>% 
  arrange(desc(total_spend)) %>% 
  summarize(total_budget = sum(total_spend)) %>% 
  ungroup()

x %>% 
    filter(type == "detailed") %>%
    filter(detailed_type == "DEMOGRAPHICS") %>% 
  filter(!is_exclusion) %>% 
    # count(value, sort = T) %>% 
    filter(str_detect(value, "grad school|degree|	|Master|[c|C]ollege|degree|[H|h]igh school|Professional degree", negate = T)) %>% 
  mutate(total_spend = total_spend_formatted) %>%
  mutate(total_spend = ifelse(total_spend == 50, 1, total_spend)) %>% 
  # filter(coalition == "Coalizione di centro-destra") %>%  
  # filter(total_spend_pct != 0) %>% 
  # group_by(internal_id) %>%
  # mutate(n_ages = n()) %>% #count(n_ages, sort = T)
  # ungroup()%>% 
  mutate(spend_per = total_spend * total_spend_pct) %>% 
  group_by(value) %>% 
  summarize(spend_per = sum(spend_per)) %>% 
  bind_cols(total_sppppeen) %>% 
  mutate(perc = spend_per/total_budget) %>% 
            mutate(coalition = x$coalition[1],
                   party = x$party[1],
                   election = x$election[1])
}

election_dat30 %>% 
    group_split(party) %>% 
    map_dfr(calc_jobs_perc) %>% 
    filter(perc >= 0.015) %>% 
    filter(str_detect(value, relationshipstuff, negate = T)) %>% 
     # mutate(coalition = fct_relevel(coalition, c("Coalizione di centro-sinistra",
     #                              "Terzo Polo",
     #                              "Coalizione di centro-destra"))) %>% 
    mutate(value = stringr::str_trunc(value, 22)) %>% 
    mutate(value = reorder_within(value, perc, party)) %>% 
    ggplot(aes(value, perc, fill = party)) +
    scale_x_reordered() +
    geom_col(alpha = 0.8) +
    facet_wrap(~party, scales = "free") +
    coord_flip() +
    ggthemes::theme_hc() +
    # scale_fill_manual(values = c("#ef3e3e", "#0039aa", "#0a6be1")) +
    theme(legend.position = "none",
          panel.spacing=unit(1,"lines")) +
    scale_y_continuous(labels = scales::percent) +
    # scale_x_discrete(breaks = c("18", "24",
    #                             "34", "44",
    #                             "54", "65+")) +
    labs(y = "% Budget Spend on Jobs") +
    labs(x = "Job (Sectors)\n")  +
  geom_text(size = 3.5, color = "black", vjust="inward",hjust="inward",
             aes(y = perc, label = paste0(round(perc*100, 1), "%")))  +
    # scale_x_discrete(label = function(x) stringr::str_trunc(x, 22)) +
    scale_fill_parties()
    


    
```


